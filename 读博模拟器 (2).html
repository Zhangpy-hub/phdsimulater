<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¯»åšäººç”Ÿæ¨¡æ‹Ÿå™¨</title>
  <style>
    :root{
      --bg:#bfe3ef;
      --panel2:#f7edd5;
      --border:#2a8fb0;
      --btn:#e9d3a6;
      --btnBorder:#b38e3e;
      --text:#111;
      --muted:#333;
      --danger:#a12b2b;
    }
    *{ box-sizing:border-box; font-family:"Microsoft YaHei","PingFang SC",system-ui,sans-serif; }
    body{ margin:0; background:#eef7fb; display:flex; justify-content:center; padding:18px; color:var(--text); }
    .game{ width:min(980px, 100%); background:var(--bg); border:3px solid var(--border); padding:14px; }
    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      background:var(--panel2); border:3px solid var(--border); padding:10px 12px;
      font-weight:800; font-size:18px;
    }
    .row{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top:12px; }
    .panel{ background:var(--panel2); border:3px solid var(--border); padding:12px; }
    .eventText{
      background:#f8f0db; border:2px solid #d7c59b; padding:14px; min-height:92px;
      font-size:18px; line-height:1.55; font-weight:800; white-space:pre-wrap;
    }
    button{
      padding:12px 10px; font-size:18px; font-weight:800; background:var(--btn);
      border:2px solid var(--btnBorder); cursor:pointer; user-select:none;
    }
    button:hover{ filter:brightness(0.98); }
    button:active{ transform: translateY(1px); }
    button.secondary{ opacity:.95; }
    button.small{ font-size:14px; padding:10px 10px; }
    button.danger{ border-color: var(--danger); }
    button:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .meta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-weight:700; font-size:14px; opacity:.95; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:2px solid #9cc9d7; background:#ffffff80; border-radius:999px; }
    .pill b{ font-weight:900; }

    .hint{ opacity:.8; font-size:13px; margin-top:8px; color:var(--muted); }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .title{ font-size:20px; font-weight:900; margin:0 0 8px 0; }
    ul{ margin:0; padding-left:22px; }

    .log{ max-height:180px; overflow:auto; background:#ffffff80; border:2px solid #9cc9d7; padding:10px; }
    .log p{ margin:0 0 8px 0; line-height:1.4; }
    .log p:last-child{ margin-bottom:0; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .subpanel{ margin-top:10px; background:#ffffff80; border:2px solid #9cc9d7; padding:10px; }
    .subpanel .subtitle{ font-weight:900; margin:0 0 6px 0; }
    .stepTip{ font-size:13px; opacity:.85; margin-top:6px; color:var(--muted); }

    .btns{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px; }

    @media (max-width:820px){
      .grid3{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="game">
    <div class="topbar">
      <div id="statsText">æ¯•ä¸šå¸Œæœ› 100/100</div>
      <div id="timeText">ç¬¬ 1 å¹´ 1 æœˆ</div>
      <div class="meta">
        <span class="pill">è®ºæ–‡æ¥æ”¶ <b id="paperCount">0</b></span>
        <span class="pill">å¯¼å¸ˆå¥½æ„Ÿ <b id="advisorAff">50</b>/100</span>
        <span class="pill">ç²¾åŠ› <b id="energy">80</b>/100</span>
        <span class="pill">èº«ä½“ç´ è´¨ <b id="health">60</b>/100</span>
        <span class="pill">ç»å† <b id="exp">20</b>/100</span>
      </div>
    </div>

    <div class="row">
      <div class="panel">
        <div id="eventText" class="eventText"></div>

        <div class="subpanel">
          <div class="subtitle">æœ¬æœˆå¯é€‰è¡ŒåŠ¨ï¼š</div>
          <div id="options" class="btns"></div>
          <div id="tip" class="stepTip"></div>
        </div>

        <div class="toolbar">
          <button id="btnSave" class="small">å­˜æ¡£</button>
          <button id="btnLoad" class="small">è¯»æ¡£</button>
          <button id="btnRestart" class="small danger">é‡æ–°å¼€å§‹</button>
        </div>

        <div class="hint">
          è¯´æ˜ï¼šæœ¬æœˆåªéœ€é€‰æ‹©ä¸€ä¸ªè¡ŒåŠ¨ã€‚å…¥å­¦é˜¶æ®µä»…æ˜¾ç¤ºå…¥å­¦ç›¸å…³é€‰é¡¹ã€‚è¯»æ–‡çŒ®å¯èƒ½è·å¾—ç ”ç©¶æ€è·¯ï¼›å­¦æœ¯ä¼šè®®æ¯å¹´éšæœºå‡ºç°ä¸€æ¬¡ï¼›è®¤çœŸå¬æ±‡æŠ¥å¯èƒ½è·å¾—é«˜çº§çµæ„Ÿã€‚æ¯•ä¸šéœ€è¦ï¼šè®ºæ–‡æ¥æ”¶ã€ä¸»çº¿èŠ‚ç‚¹ã€å¯¼å¸ˆå¥½æ„Ÿåº¦è¾¾æ ‡ã€‚å¦æœ‰éšè—ç»“å±€â€œæ­¦åŠ›æ¯•ä¸šâ€ã€‚
        </div>
      </div>

      <div class="grid3">
        <div class="panel">
          <div class="title">ç‰©å“ï¼š</div>
          <ul id="items"></ul>
        </div>

        <div class="panel">
          <div class="title">çŠ¶æ€ï¼š</div>
          <ul id="status"></ul>
        </div>

        <div class="panel">
          <div class="title">æ—¥å¿—ï¼š</div>
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // -------------------------
  // å·¥å…·
  // -------------------------
  const clamp = (v, min=0, max=100) => Math.max(min, Math.min(max, Math.round(v)));
  const pickWeighted = (arr) => {
    const total = arr.reduce((s, e) => s + (e.weight ?? 1), 0);
    let r = Math.random() * total;
    for (const e of arr){
      r -= (e.weight ?? 1);
      if (r <= 0) return e;
    }
    return arr[arr.length - 1];
  };
  const fmtDelta = (label, d) => (d === 0 ? null : `${label}${d>0?"+":""}${d}`);
  const countItem = (s, name) => s.items.filter(x => x === name).length;
  const removeOneItem = (s, name) => { const i = s.items.indexOf(name); if (i >= 0) s.items.splice(i, 1); };

  // -------------------------
  // çŠ¶æ€
  // -------------------------
  const initialState = () => ({
    year: 1,
    month: 1,

    hope: 100,
    pressure: 20,
    research: 5,
    money: 40,
    energy: 80,
    health: 60,
    advisorAff: 50,
    exp: 20,

    papers: 0,
    milestones: { offer:false, proposal:false, midterm:false, predef:false, defense:false },

    flags: {
      ideaGoodReady: false,      // ä¸‹æœˆå‡ºç°â€œè½¬å†™è®ºæ–‡â€
      submittedFromIdea: false,  // å·²æŠ•ç­‰å¾…ç»“æœ
    },

    conference: { year: 1, month: 1, done: false },

    items: [],
    status: ["æ¿€åŠ¨äººå¿ƒçš„ç¬¬ä¸€å¹´"],
    log: [],
    currentEventId: null,

    gameOver: false,
    ending: ""
  });

  let state = initialState();
  const usedOnce = new Set();

  function roll(prob){ return Math.random() < prob; }

  function scheduleConferenceForYear(s){
    s.conference.year = s.year;
    s.conference.month = 1 + Math.floor(Math.random() * 12);
    s.conference.done = false;
    s.log.unshift("æ–°çš„ä¸€å¹´å¼€å§‹äº†ã€‚");
  }

  // -------------------------
  // äº‹ä»¶åº“
  // -------------------------
  const events = [
    {
      id: "phd_offer",
      once: true,
      weight: 999,
      when: s => !s.milestones.offer,
      text: "æ­å–œæ‚¨æ”¶åˆ°äº†æˆ‘ä»¬çš„åšå£«å½•å–é€šçŸ¥ä¹¦ï¼æ‚¨æ„¿æ„æ¥æˆ‘ä»¬å­¦é™¢è¯»åšä¹ˆï¼Ÿ",
      options: (s) => ([
        {
          label: "æ¥å—",
          run: () => {
            s.milestones.offer = true;
            s.items.push("å­¦ç”Ÿè¯");
            s.status.unshift("è¸å…¥è¯»åšä¹‹è·¯");
            s.log.unshift("ä½ é€‰æ‹©æ¥å—å½•å–ï¼Œè¯»åšç”Ÿæ¶¯å¼€å¯ã€‚");
            applyDeltas(s, { hope:+5, pressure:+10, advisorAff:+5 });
            nextMonth(s);
          }
        },
        {
          label: "æ‹’ç»",
          run: () => {
            s.milestones.offer = true;
            s.status.unshift("é€‰æ‹©äº†å¦ä¸€æ¡äººç”Ÿé“è·¯");
            s.log.unshift("ä½ æ‹’ç»äº†å½•å–é€šçŸ¥ä¹¦ã€‚æ•…äº‹åœ¨è¿™é‡Œç»“æŸã€‚");
            applyDeltas(s, { hope:-30 });
            s.gameOver = true;
            s.ending = "ç»“å±€ï¼šæœªå…¥å­¦ã€‚";
            render();
          }
        }
      ])
    },

    {
      id: "progress_day",
      weight: 6,
      when: s => s.milestones.offer && !s.gameOver,
      text: "ä»Šå¤©ä½ æ‰“ç®—æ€ä¹ˆæ¨è¿›ï¼Ÿ",
      options: (s) => ([
        {
          label: "è¯»æ–‡çŒ®",
          run: () => {
            if (roll(0.80)){
              s.items.push("ç ”ç©¶æ€è·¯");
              s.status.unshift("çµå…‰ä¸€é—ªï¼šæœ‰äº†æ–°çš„ç ”ç©¶æ€è·¯");
              s.log.unshift("ä½ è¯»äº†å¤§é‡æ–‡çŒ®ï¼Œè·å¾—ã€ç ”ç©¶æ€è·¯ã€‘ã€‚");
            } else {
              s.status.unshift("è¯»åˆ°çœ¼èŠ±ï¼šæš‚æ—¶æ²¡çªç ´");
              s.log.unshift("ä½ è¯»äº†ä¸å°‘æ–‡çŒ®ï¼Œä½†æš‚æ—¶æ²¡å½¢æˆå¯æ‰§è¡Œçš„æ€è·¯ã€‚");
            }
            applyDeltas(s, { research:+6, pressure:+3, energy:-6, advisorAff:+1 });
            nextMonth(s);
          }
        },
        {
          label: "ç›´æ¥åšå®éªŒ/å†™ä»£ç ",
          run: () => {
            s.status.unshift("ä½ æŠŠæ—¶é—´ç ¸åœ¨å®ç°ä¸Š");
            s.log.unshift("ä½ é€‰æ‹©ç›´æ¥æ¨è¿›å®ç°ã€‚");
            applyDeltas(s, { research:+8, pressure:+5, energy:-8 });
            nextMonth(s);
          }
        }
      ])
    },

    {
      id: "advisor_meeting",
      weight: 4,
      when: s => s.milestones.offer && !s.gameOver,
      text: "å¯¼å¸ˆçº¦ä½ å¼€ç»„ä¼šï¼šä½ æ›´æƒ³â€œè®¤çœŸå‡†å¤‡â€è¿˜æ˜¯â€œéšä¾¿åº”ä»˜â€ï¼Ÿ",
      options: (s) => ([
        {
          label: "è®¤çœŸå‡†å¤‡",
          run: () => {
            s.status.unshift("ç»„ä¼šè¡¨ç°ä¸é”™ï¼Œå¯¼å¸ˆç‚¹äº†ç‚¹å¤´");
            s.log.unshift("ä½ è®¤çœŸå‡†å¤‡äº†ç»„ä¼šï¼Œå¯¼å¸ˆå¯¹ä½ æ›´æ”¾å¿ƒäº†ã€‚");
            applyDeltas(s, { research:+10, pressure:+8, advisorAff:+10, energy:-8 });
            nextMonth(s);
          }
        },
        {
          label: "éšä¾¿åº”ä»˜",
          run: () => {
            s.status.unshift("å¯¼å¸ˆæ²‰é»˜äº†ä¸‰ç§’ï¼šä¸‹æ¬¡åˆ«è¿™æ ·");
            s.log.unshift("ä½ éšä¾¿åº”ä»˜ç»„ä¼šï¼Œè¢«å¯¼å¸ˆè®°äº†ä¸€ç¬”ã€‚");
            applyDeltas(s, { research:-5, hope:-5, advisorAff:-10, pressure:+5 });
            nextMonth(s);
          }
        }
      ])
    },

    {
      id: "proposal_prepare",
      weight: 3,
      when: s => s.milestones.offer && !s.milestones.proposal && s.year >= 1 && s.month >= 3 && !s.gameOver,
      text: "å¼€é¢˜é€¼è¿‘ï¼šä½ è¦ä¸è¦æŠŠæœªæ¥ä¸¤å‘¨éƒ½ç ¸åœ¨æ–‡çŒ®å’Œæ–¹æ¡ˆä¸Šï¼Ÿ",
      options: (s) => ([
        {
          label: "å…¨åŠ›å¼€é¢˜",
          run: () => {
            s.status.unshift("ä½ æ³¡åœ¨æ–‡çŒ®é‡Œï¼Œæ–¹æ¡ˆé€æ¸æˆå‹");
            s.log.unshift("ä½ å…¨åŠ›å‡†å¤‡å¼€é¢˜ã€‚");
            applyDeltas(s, { research:+14, pressure:+10, energy:-12, advisorAff:+6 });
            nextMonth(s);
          }
        },
        {
          label: "å…ˆç¼“ä¸€ç¼“",
          run: () => {
            s.status.unshift("å¼€é¢˜å‡†å¤‡æ‹–äº†æ‹–ï¼Œå¿ƒé‡Œæœ‰ç‚¹è™š");
            s.log.unshift("ä½ é€‰æ‹©ç¼“ä¸€ç¼“ã€‚");
            applyDeltas(s, { research:+4, pressure:+8, hope:-4, energy:+6 });
            nextMonth(s);
          }
        }
      ])
    },
    {
      id: "proposal_defense",
      weight: 2,
      when: s => s.milestones.offer && !s.milestones.proposal && s.research >= 25 && !s.gameOver,
      text: "å¼€é¢˜ç­”è¾©å½“å¤©ï¼šä½ æ›´æƒ³â€œç¨³æ‰ç¨³æ‰“â€è¿˜æ˜¯â€œå¤§èƒ†å™äº‹â€ï¼Ÿ",
      options: (s) => ([
        {
          label: "ç¨³æ‰ç¨³æ‰“",
          run: () => {
            s.milestones.proposal = true;
            s.status.unshift("å¼€é¢˜é€šè¿‡ï¼ä½ æ¾äº†å£æ°”");
            s.items.push("å¼€é¢˜é€šè¿‡è¯æ˜");
            s.log.unshift("ä½ ç¨³æ‰ç¨³æ‰“åœ°æ±‡æŠ¥ï¼Œå¼€é¢˜é€šè¿‡ã€‚");
            applyDeltas(s, { hope:+8, pressure:-8, advisorAff:+8, energy:-6 });
            nextMonth(s);
          }
        },
        {
          label: "å¤§èƒ†å™äº‹",
          run: () => {
            const ok = roll(0.45 + s.advisorAff/200);
            if (ok){
              s.milestones.proposal = true;
              s.status.unshift("å¼€é¢˜é€šè¿‡ï¼šå§”å‘˜ä»¬è¿½é—®å¾ˆç‹ ");
              s.items.push("å¼€é¢˜é€šè¿‡è¯æ˜");
              s.log.unshift("ä½ å¤§èƒ†å™äº‹ï¼Œé™©è¿‡å¼€é¢˜ã€‚");
              applyDeltas(s, { hope:+6, pressure:+2, advisorAff:+4, energy:-10 });
            } else {
              s.status.unshift("å¼€é¢˜è¢«è¦æ±‚å¤§ä¿®ï¼Œå¿ƒæ€æœ‰ç‚¹å´©");
              s.log.unshift("ä½ è¢«æŠ“ä½é€»è¾‘æ¼æ´ï¼Œå¼€é¢˜å¤§ä¿®ã€‚");
              applyDeltas(s, { hope:-10, pressure:+15, advisorAff:-6, energy:-8 });
            }
            nextMonth(s);
          }
        }
      ])
    },

    {
      id: "midterm_notice",
      weight: 3,
      when: s => s.milestones.proposal && !s.milestones.midterm && s.year >= 2 && !s.gameOver,
      text: "å­¦é™¢é€šçŸ¥ï¼šä¸­æœŸè€ƒæ ¸åœ¨ä¸‰ä¸ªæœˆåã€‚ä½ è¦â€œåŠ é€Ÿå®éªŒâ€è¿˜æ˜¯â€œå…ˆæŠŠç”Ÿæ´»ç¨³ä½â€ï¼Ÿ",
      options: (s) => ([
        {
          label: "åŠ é€Ÿå®éªŒ",
          run: () => {
            s.status.unshift("ä½ å¼€å§‹ç–¯ç‹‚è·‘å®éªŒ");
            s.log.unshift("ä½ é€‰æ‹©åŠ é€Ÿå®éªŒã€‚");
            applyDeltas(s, { research:+12, pressure:+12, energy:-14, money:-3 });
            nextMonth(s);
          }
        },
        {
          label: "ç¨³ä½ç”Ÿæ´»",
          run: () => {
            s.status.unshift("ä½ æŠŠèŠ‚å¥è°ƒç¨³ï¼Œæ•ˆç‡æ›´å¯æŒç»­");
            s.log.unshift("ä½ å…ˆç¨³ä½ç”Ÿæ´»ã€‚");
            applyDeltas(s, { research:+6, pressure:-6, energy:+10, hope:+2 });
            nextMonth(s);
          }
        }
      ])
    },
    {
      id: "midterm_exam",
      weight: 2,
      when: s => s.milestones.proposal && !s.milestones.midterm && s.year >= 2 && s.research >= 45 && !s.gameOver,
      text: "ä¸­æœŸè€ƒæ ¸ï¼šå§”å‘˜é—®ä½ â€œæ ¸å¿ƒè´¡çŒ®æ˜¯ä»€ä¹ˆï¼Ÿâ€ä½ é€‰æ‹©â€œèšç„¦ä¸»çº¿â€è¿˜æ˜¯â€œé“ºå¼€å¾ˆå¤šç‚¹â€ï¼Ÿ",
      options: (s) => ([
        {
          label: "èšç„¦ä¸»çº¿",
          run: () => {
            s.milestones.midterm = true;
            s.status.unshift("ä¸­æœŸé€šè¿‡ï¼æ–¹å‘æ›´æ¸…æ™°äº†");
            s.items.push("ä¸­æœŸé€šè¿‡è¯æ˜");
            s.log.unshift("ä½ èšç„¦ä¸»çº¿ï¼Œä¸­æœŸé€šè¿‡ã€‚");
            applyDeltas(s, { hope:+10, pressure:-10, advisorAff:+8, energy:-8 });
            nextMonth(s);
          }
        },
        {
          label: "é“ºå¼€å¾ˆå¤šç‚¹",
          run: () => {
            const ok = roll(0.35 + s.research/200);
            if (ok){
              s.milestones.midterm = true;
              s.status.unshift("ä¸­æœŸå‹‰å¼ºé€šè¿‡ï¼šå»ºè®®æ”¶æ•›é—®é¢˜");
              s.items.push("ä¸­æœŸé€šè¿‡è¯æ˜");
              s.log.unshift("ä½ è®²äº†å¾ˆå¤šç‚¹ï¼Œå‹‰å¼ºé€šè¿‡ã€‚");
              applyDeltas(s, { hope:+6, pressure:-4, advisorAff:+2, energy:-10 });
            } else {
              s.status.unshift("ä¸­æœŸè¢«å»¶åï¼šéœ€è¦è¡¥å……å…³é”®å®éªŒ");
              s.log.unshift("ä½ è®²å¾—å¤ªæ•£ï¼Œä¸­æœŸå»¶åã€‚");
              applyDeltas(s, { hope:-8, pressure:+12, advisorAff:-4, energy:-8 });
            }
            nextMonth(s);
          }
        }
      ])
    },

    {
      id: "write_paper_from_idea",
      weight: 999,
      when: s => s.flags.ideaGoodReady && !s.flags.submittedFromIdea && !s.gameOver,
      text: "ä½ æ²¿ç€æ€è·¯æ¨è¿›å‡ºäº†ä¸€ä¸ªå¯è®²çš„ç»“æœã€‚ç°åœ¨è¦ä¸è¦æŠŠå®ƒè½¬å†™æˆè®ºæ–‡å¹¶æŠ•ç¨¿ï¼Ÿ",
      options: (s) => ([
        {
          label: "è½¬å†™è®ºæ–‡å¹¶æŠ•ç¨¿",
          run: () => {
            s.flags.submittedFromIdea = true;
            s.flags.ideaGoodReady = false;
            s.status.unshift("ä½ å¼€å§‹è½¬å†™è®ºæ–‡ï¼šç—›å¹¶å¿«ä¹ç€");
            s.log.unshift("ä½ æŠŠç»“æœè½¬å†™æˆè®ºæ–‡å¹¶æŠ•ç¨¿ã€‚å¯¼å¸ˆä¹Ÿå¼€å§‹æ›´å…³æ³¨ä½ çš„è¿›å±•ã€‚");
            applyDeltas(s, { pressure:+12, energy:-14, money:-2, advisorAff:+6 });
            nextMonth(s);
          }
        },
        {
          label: "å†è¡¥å®éªŒå†è¯´",
          run: () => {
            s.flags.ideaGoodReady = false;
            s.status.unshift("ä½ é€‰æ‹©å…ˆè¡¥å®éªŒï¼šæ›´ç¨³ä½†æ›´æ…¢");
            s.log.unshift("ä½ é€‰æ‹©å…ˆè¡¥å®éªŒå†å†™è®ºæ–‡ã€‚");
            applyDeltas(s, { research:+6, pressure:+6, energy:-8, advisorAff:+1 });
            nextMonth(s);
          }
        }
      ])
    },

    {
      id: "paper_result_from_idea",
      weight: 999,
      when: s => s.flags.submittedFromIdea && !s.gameOver,
      text: "ç¼–è¾‘é‚®ä»¶æ¥äº†ï¼šè¿™æ¬¡æŠ•ç¨¿çš„å‘½è¿å¦‚ä½•ï¼Ÿ",
      options: (s) => ([
        {
          label: "ç‚¹å¼€é‚®ä»¶",
          run: () => {
            const p = 0.35 + s.research/300 + s.advisorAff/500 - s.pressure/600;
            const ok = roll(p);
            if (ok){
              s.papers += 1;
              s.flags.submittedFromIdea = false;
              s.status.unshift("è®ºæ–‡æ¥æ”¶ï¼ä½ ç»ˆäºæ„Ÿè§‰è‡ªå·±åƒä¸ªç ”ç©¶è€…");
              s.log.unshift("æŠ•ç¨¿æˆåŠŸï¼šè®ºæ–‡æ¥æ”¶ï¼ˆ+1ï¼‰ã€‚å¯¼å¸ˆå¾ˆæ»¡æ„ã€‚");
              applyDeltas(s, { hope:+12, pressure:-14, energy:+6, advisorAff:+10 });
            } else {
              s.flags.submittedFromIdea = false;
              s.status.unshift("æ‹’ç¨¿/å¤§ä¿®ï¼šéœ€è¦ç»§ç»­æ‰“ç£¨");
              s.log.unshift("æŠ•ç¨¿å¤±è´¥ï¼šä½ å†³å®šç»§ç»­æ‰“ç£¨å¹¶è°ƒæ•´ç­–ç•¥ã€‚");
              applyDeltas(s, { hope:-4, pressure:+10, energy:-6, advisorAff:+1 });
            }
            nextMonth(s);
          }
        },
        {
          label: "å…ˆæ·±å‘¼å¸å†çœ‹",
          run: () => {
            const p = 0.35 + s.research/300 + s.advisorAff/500 - s.pressure/650;
            const ok = roll(p);
            if (ok){
              s.papers += 1;
              s.flags.submittedFromIdea = false;
              s.status.unshift("è®ºæ–‡æ¥æ”¶ï¼ä½ ä¹…è¿åœ°ç¡äº†ä¸ªè¸å®è§‰");
              s.log.unshift("æŠ•ç¨¿æˆåŠŸï¼šè®ºæ–‡æ¥æ”¶ï¼ˆ+1ï¼‰ã€‚å¯¼å¸ˆå¯¹ä½ åˆ®ç›®ç›¸çœ‹ã€‚");
              applyDeltas(s, { hope:+12, pressure:-16, energy:+8, advisorAff:+10 });
            } else {
              s.flags.submittedFromIdea = false;
              s.status.unshift("æ‹’ç¨¿/å¤§ä¿®ï¼šä½†å¿ƒæ€æ›´ç¨³äº†");
              s.log.unshift("æŠ•ç¨¿å¤±è´¥ï¼šä½†ä½ æ‰›ä½äº†ï¼Œç»§ç»­è¿­ä»£ã€‚");
              applyDeltas(s, { hope:-2, pressure:+7, energy:+2, advisorAff:+1 });
            }
            nextMonth(s);
          }
        }
      ])
    },

    // é¢„ç­”è¾©ï¼šå¢åŠ å¯¼å¸ˆå¥½æ„Ÿé—¨æ§›
    {
      id: "predefense",
      weight: 3,
      when: s => s.milestones.midterm && !s.milestones.predef && s.research >= 80 && s.papers >= 1 && s.advisorAff >= 80 && !s.gameOver,
      text: "å¯¼å¸ˆè¯´ï¼šå¯ä»¥å‡†å¤‡é¢„ç­”è¾©äº†ã€‚ä½ é€‰æ‹©â€œè¿…é€Ÿæˆç¨¿â€è¿˜æ˜¯â€œåå¤æ‰“ç£¨â€ï¼Ÿ",
      options: (s) => ([
        {
          label: "è¿…é€Ÿæˆç¨¿",
          run: () => {
            s.milestones.predef = true;
            s.status.unshift("é¢„ç­”è¾©é€šè¿‡ï¼šä½†è¢«æŒ‡å‡ºä¸å°‘ç»†èŠ‚");
            s.items.push("é¢„ç­”è¾©è®°å½•");
            s.log.unshift("ä½ è¿…é€Ÿæˆç¨¿ï¼Œé€šè¿‡é¢„ç­”è¾©ã€‚");
            applyDeltas(s, { hope:+6, pressure:+6, energy:-10, advisorAff:+2 });
            nextMonth(s);
          }
        },
        {
          label: "åå¤æ‰“ç£¨",
          run: () => {
            s.milestones.predef = true;
            s.status.unshift("é¢„ç­”è¾©é€šè¿‡ï¼šé€»è¾‘æ›´é¡ºï¼Œåº•æ°”æ›´è¶³");
            s.items.push("é¢„ç­”è¾©è®°å½•");
            s.log.unshift("ä½ åå¤æ‰“ç£¨ï¼Œé€šè¿‡é¢„ç­”è¾©ã€‚");
            applyDeltas(s, { hope:+8, pressure:+4, energy:-14, advisorAff:+4 });
            nextMonth(s);
          }
        }
      ])
    },

    // ç­”è¾©ï¼šå¯¼å¸ˆå¥½æ„Ÿé—¨æ§›
    {
      id: "defense",
      weight: 3,
      when: s => s.milestones.predef && !s.milestones.defense && s.research >= 90 && s.papers >= 1 && s.hope >= 20 && s.advisorAff >= 80 && !s.gameOver,
      text: "æœ€ç»ˆç­”è¾©ï¼šä½ ç«™ä¸Šè®²å°ã€‚ä½ é€‰æ‹©â€œç¨³ä½èŠ‚å¥â€è¿˜æ˜¯â€œåŠ é€Ÿè®²å®Œâ€ï¼Ÿ",
      options: (s) => ([
        {
          label: "ç¨³ä½èŠ‚å¥",
          run: () => {
            const passProb = 0.70 + s.advisorAff/400 + s.energy/500 - s.pressure/500;
            const pass = roll(passProb);
            if (pass){
              s.milestones.defense = true;
              s.status.unshift("ç­”è¾©é€šè¿‡ï¼ä½ ç»ˆäºæ¯•ä¸šäº†");
              s.log.unshift("ç­”è¾©é€šè¿‡ï¼Œåœ†æ»¡æ¯•ä¸šï¼");
              applyDeltas(s, { hope:+10, pressure:-15, advisorAff:+2 });
              s.gameOver = true;
              s.ending = "ç»“å±€ï¼šé¡ºåˆ©æ¯•ä¸š ğŸ“";
              render();
            } else {
              s.status.unshift("ç­”è¾©è¢«è¦æ±‚å¤§ä¿®ï¼šè¿˜è¦å†æˆ˜ä¸€æ¬¡");
              s.log.unshift("ç­”è¾©æ²¡æœ‰ä¸€æ¬¡è¿‡ï¼šéœ€è¦å¤§ä¿®å†ç­”ã€‚");
              applyDeltas(s, { hope:-10, pressure:+12, energy:-12, advisorAff:-3 });
              nextMonth(s);
            }
          }
        },
        {
          label: "åŠ é€Ÿè®²å®Œ",
          run: () => {
            const passProb = 0.60 + s.research/300 + s.advisorAff/500 - s.pressure/450;
            const pass = roll(passProb);
            if (pass){
              s.milestones.defense = true;
              s.status.unshift("ç­”è¾©é€šè¿‡ï¼ä½ å·®ç‚¹åœ¨å°ä¸Šè…¿è½¯");
              s.log.unshift("ä½ åŠ é€Ÿè®²å®Œï¼ŒæƒŠé™©é€šè¿‡ï¼");
              applyDeltas(s, { hope:+8, pressure:-10, advisorAff:+2 });
              s.gameOver = true;
              s.ending = "ç»“å±€ï¼šæƒŠé™©æ¯•ä¸š ğŸ“";
              render();
            } else {
              s.status.unshift("é—®ç­”ç¯èŠ‚è¢«è¿½ç€æ‰“ï¼šéœ€è¦è¡¥ææ–™");
              s.log.unshift("ä½ è®²å¤ªå¿«å¯¼è‡´é€»è¾‘ç©ºæ´ï¼Œè¢«è¿½é—®åˆ°è¡¥ææ–™ã€‚");
              applyDeltas(s, { hope:-12, pressure:+15, energy:-14, advisorAff:-5 });
              nextMonth(s);
            }
          }
        }
      ])
    },
  ];

  // -------------------------
  // å­¦æœ¯ä¼šè®®
  // -------------------------
  function conferenceEventOptions(s){
    return [
      {
        label: "é€›é€›å½“åœ°åŸå¸‚",
        run: () => {
          s.conference.done = true;
          s.status.unshift("ä¼šåä½ é€›äº†åŸå¸‚ï¼šå¿ƒæƒ…æ”¾æ¾ï¼Œçœ¼ç•Œæ›´å¼€é˜”");
          s.log.unshift("ä½ åœ¨å½“åœ°è½¬äº†è½¬ï¼Œæ”¶è·äº†ä¸ä¸€æ ·çš„è§†è§’ã€‚");
          applyDeltas(s, { exp:+10, pressure:-10, energy:+6, health:+3 });
          nextMonth(s);
        }
      },
      {
        label: "è®¤çœŸå¬æ±‡æŠ¥",
        run: () => {
          s.conference.done = true;
          s.status.unshift("ä½ è®¤çœŸå¬å®Œä¸€æ•´å¤©ï¼šè„‘è¢‹å—¡å—¡ï¼Œä½†æ”¶è·å¾ˆå®åœ¨");
          s.log.unshift("ä½ è®¤çœŸå¬æ±‡æŠ¥ï¼Œåšäº†å¤§é‡ç¬”è®°ã€‚å¯¼å¸ˆå¯¹ä½ çš„å­¦æœ¯æ€åº¦æ›´è®¤å¯äº†ã€‚");
          applyDeltas(s, { pressure:+6, advisorAff:+10, exp:+8, energy:-6 });

          if (roll(0.80)){
            s.items.push("é«˜çº§çµæ„Ÿ");
            s.status.unshift("ä½ æ•æ‰åˆ°ä¸€ä¸ªæ›´æˆç†Ÿçš„æƒ³æ³•ï¼šé«˜çº§çµæ„Ÿå…¥æ‰‹");
            s.log.unshift("ä½ æ•´ç†ç¬”è®°æ—¶çªç„¶ä¸²èµ·å…³é”®ç‚¹ï¼Œè·å¾—ã€é«˜çº§çµæ„Ÿã€‘ã€‚");
          } else {
            s.status.unshift("ä½ è®°äº†å¾ˆå¤šç¬”è®°ï¼šä½†æš‚æ—¶è¿˜æ²¡ä¸²èµ·æ¥");
            s.log.unshift("è¿™æ¬¡æ²¡æœ‰å½¢æˆå¯ç«‹å³æ‰§è¡Œçš„é«˜çº§çµæ„Ÿã€‚");
          }
          nextMonth(s);
        }
      }
    ];
  }

  // -------------------------
  // ç”Ÿæ´»é€‰é¡¹ï¼ˆè§£å‹ä¼šå›ä¸€ç‚¹ç²¾åŠ›ï¼‰
  // -------------------------
  const lifestyleOptions = [
    {
      label: "å–é…’è§£å‹",
      run: (s) => {
        s.log.unshift("ä½ é€‰æ‹©å–é…’è§£å‹ï¼šçŸ­æš‚æ”¾æ¾ï¼Œä½†èº«ä½“åƒä¸æ¶ˆã€‚");
        s.status.unshift("ä½ å¾®é†ºå…¥ç¡ï¼šç¡å¾—æ›´æ²‰ï¼Œä½†ç¬¬äºŒå¤©æœ‰ç‚¹è™š");
        applyDeltas(s, { pressure:-10, health:-5, energy:+4 });
        nextMonth(s);
      }
    },
    {
      label: "å¥èº«",
      run: (s) => {
        s.log.unshift("ä½ é€‰æ‹©å¥èº«ï¼šå‹åŠ›ä¸‹é™ï¼Œèº«ä½“ç´ è´¨æå‡ã€‚");
        s.status.unshift("ä½ æµäº†å¾ˆå¤šæ±—ï¼šä½†æ•´ä¸ªäººæ›´æ¸…é†’äº†");
        applyDeltas(s, { pressure:-5, health:+5, energy:+4 });
        nextMonth(s);
      }
    },
    {
      label: "æ‰“æ¸¸æˆ",
      run: (s) => {
        s.log.unshift("ä½ é€‰æ‹©æ‰“æ¸¸æˆï¼šå¿ƒæƒ…å¥½ç‚¹ï¼Œä½†ä¹…åä¼¤èº«ã€‚");
        s.status.unshift("ä½ çŸ­æš‚é€ƒç¦»ç°å®ï¼šå‹åŠ›ä¸‹é™äº†");
        applyDeltas(s, { pressure:-8, health:-3, energy:+3 });
        nextMonth(s);
      }
    }
  ];

  // -------------------------
  // æ€è·¯/é«˜çº§çµæ„Ÿè·¯å¾„ï¼ˆä¸æ˜¾ç¤ºæ¦‚ç‡ï¼‰
  // -------------------------
  function canUseIdea(s){ return countItem(s, "ç ”ç©¶æ€è·¯") > 0 && !s.flags.ideaGoodReady && !s.flags.submittedFromIdea && !s.gameOver; }
  function canUseAdvancedIdea(s){ return countItem(s, "é«˜çº§çµæ„Ÿ") > 0 && !s.flags.ideaGoodReady && !s.flags.submittedFromIdea && !s.gameOver; }

  function doIdeaPath(s){
    const good = roll(0.60);
    if (good){
      s.flags.ideaGoodReady = true;
      s.status.unshift("æ€è·¯éªŒè¯æˆåŠŸï¼šå‡ºç°äº†å¯è®²çš„ç»“æœ");
      s.log.unshift("ä½ æ²¿ç€ç ”ç©¶æ€è·¯æ¨è¿›ï¼šæ–¹å‘é€šäº†ã€‚");
      applyDeltas(s, { research:+12, pressure:+6, energy:-10, advisorAff:+2 });
    } else {
      removeOneItem(s, "ç ”ç©¶æ€è·¯");
      s.status.unshift("æ€è·¯æ’å¢™ï¼šæ–¹å‘èµ°åäº†");
      s.log.unshift("ä½ æ²¿ç€ç ”ç©¶æ€è·¯æ¨è¿›ï¼šæœ€ç»ˆèµ°åäº†ã€‚");
      applyDeltas(s, { research:-2, pressure:+10, energy:-8, hope:-4 });
    }
    nextMonth(s);
  }

  function doAdvancedIdeaPath(s){
    const good = roll(0.80);
    if (good){
      removeOneItem(s, "é«˜çº§çµæ„Ÿ");
      s.flags.ideaGoodReady = true;
      s.status.unshift("é«˜çº§çµæ„Ÿè½åœ°ï¼šä½ æ‹¿åˆ°ä¸€ä¸ªæ‰å®çš„ç»“æœé›å½¢");
      s.log.unshift("ä½ æ²¿ç€é«˜çº§çµæ„Ÿæ¨è¿›ï¼šç»“æœæ›´æ‰å®ã€‚");
      applyDeltas(s, { research:+16, pressure:+7, energy:-12, advisorAff:+4, exp:+4 });
    } else {
      removeOneItem(s, "é«˜çº§çµæ„Ÿ");
      s.status.unshift("é«˜çº§çµæ„Ÿä¹Ÿä¼šå¤±æ‰‹ï¼šå…³é”®å‡è®¾ä¸æˆç«‹");
      s.log.unshift("ä½ æ²¿ç€é«˜çº§çµæ„Ÿæ¨è¿›ï¼šå‡è®¾ä¸æˆç«‹ï¼Œåªèƒ½æ¨å€’é‡æ¥ã€‚");
      applyDeltas(s, { research:-3, pressure:+12, energy:-10, hope:-5 });
    }
    nextMonth(s);
  }

  // -------------------------
  // æœˆåº¦ç»“ç®— + ç»“å±€åˆ¤å®š
  // -------------------------
  function checkSpecialEnding(s){
    // æ­¦åŠ›æ¯•ä¸šï¼šå¥åº·æ»¡ã€å¥½æ„Ÿä½ã€è®ºæ–‡ä¸¤ç¯‡ï¼ˆå¹¶ä¸”å·²ç»å…¥å­¦ï¼‰
    if (s.milestones.offer && s.health >= 100 && s.advisorAff < 60 && s.papers >= 2 && !s.gameOver){
      s.gameOver = true;
      s.ending = "ç»“å±€ï¼šæ­¦åŠ›æ¯•ä¸š ğŸ’ªğŸ“";
      s.status.unshift("ä½ æ‹æ¡Œè€Œèµ·ï¼šæ­¦åŠ›æ¯•ä¸šè¾¾æˆ");
      s.log.unshift("ä½ é ç€è¶…å¼ºèº«ä½“ç´ è´¨å’Œä¸¤ç¯‡è®ºæ–‡å¼ºè¡Œæ¯•ä¸šã€‚å¯¼å¸ˆå¥½æ„Ÿä¸é«˜ï¼Œä½†ä¹Ÿæ‹¦ä¸ä½ä½ ã€‚");
      return true;
    }
    return false;
  }

  function monthlyTick(s){
    s.pressure = clamp(s.pressure + 2);
    s.energy = clamp(s.energy - 2);
    s.money = clamp(s.money - 1);

    if (s.pressure >= 85) s.hope = clamp(s.hope - 4);
    if (s.energy <= 15) s.hope = clamp(s.hope - 3);

    if (s.health <= 15){
      s.pressure = clamp(s.pressure + 2);
      s.hope = clamp(s.hope - 2);
      s.status.unshift("èº«ä½“æŠ¥è­¦ï¼šéœ€è¦ä¼‘æ¯");
      s.log.unshift("ä½ çš„èº«ä½“ç´ è´¨è¿‡ä½ï¼šæ›´å®¹æ˜“ç„¦è™‘å’Œæ²®ä¸§ã€‚");
    }

    if (s.money <= 10) s.pressure = clamp(s.pressure + 3);

    if (s.energy >= 70) s.research = clamp(s.research + 1);
    if (s.energy <= 20) s.research = clamp(s.research - 1);

    // æ­¦åŠ›æ¯•ä¸šä¼˜å…ˆäºå´©æºƒç»“å±€ï¼ˆæ›´æœ‰æˆå‰§æ€§ï¼‰
    if (checkSpecialEnding(s)) return;

    if (s.hope <= 0 && !s.gameOver){
      s.gameOver = true;
      s.ending = "ç»“å±€ï¼šå¸Œæœ›å½’é›¶ï¼Œé€‰æ‹©é€€å­¦/è½¬å‘ã€‚";
      s.log.unshift("ä½ çš„æ¯•ä¸šå¸Œæœ›å½’é›¶ï¼Œè¯»åšä¹‹è·¯æš‚æ—¶ç”»ä¸Šå¥å·ã€‚");
      s.status.unshift("å¿ƒæ€å´©æºƒ");
      return;
    }
    if (s.pressure >= 100 && !s.gameOver){
      s.gameOver = true;
      s.ending = "ç»“å±€ï¼šå‹åŠ›çˆ†è¡¨ï¼Œå¼ºåˆ¶ä¼‘å­¦ã€‚";
      s.log.unshift("å‹åŠ›çˆ†è¡¨ï¼Œä½ ä¸å¾—ä¸ä¼‘å­¦ã€‚");
      s.status.unshift("å‹åŠ›çˆ†è¡¨");
      return;
    }
  }

  function advanceTime(s){
    s.month += 1;
    if (s.month > 12){
      s.month = 1;
      s.year += 1;
      scheduleConferenceForYear(s);
    }
  }

  function prettyKey(k){
    switch(k){
      case "hope": return "å¸Œæœ›";
      case "pressure": return "å‹åŠ›";
      case "research": return "è¿›å±•";
      case "money": return "èµ„é‡‘";
      case "energy": return "ç²¾åŠ›";
      case "health": return "å¥åº·";
      case "advisorAff": return "å¥½æ„Ÿ";
      case "exp": return "ç»å†";
      default: return k;
    }
  }

  function applyDeltas(s, deltas){
    const changes = [];
    const keys = ["hope","pressure","research","money","energy","health","advisorAff","exp"];
    for (const k of keys){
      if (typeof deltas[k] === "number"){
        const before = s[k];
        s[k] = clamp(s[k] + deltas[k]);
        const d = s[k] - before;
        if (d !== 0) changes.push([k, d]);
      }
    }
    const parts = changes.map(([k,d]) => fmtDelta(prettyKey(k), d)).filter(Boolean);
    if (parts.length) s.log.unshift(`å±æ€§å˜åŒ–ï¼š${parts.join("ï¼Œ")}`);

    // è¡ŒåŠ¨åä¹Ÿæ£€æŸ¥ä¸€æ¬¡ç‰¹æ®Šç»“å±€ï¼ˆæ¯”å¦‚å¥èº«è¡¥åˆ°100ï¼‰
    checkSpecialEnding(s);
  }

  function pickEventFor(s){
    const pool = events.filter(e => {
      if (e.once && usedOnce.has(e.id)) return false;
      if (typeof e.when === "function" && !e.when(s)) return false;
      return true;
    });
    if (!pool.length) return null;
    return pickWeighted(pool);
  }

  function nextMonth(s){
    if (s.gameOver){ render(); return; }

    advanceTime(s);
    monthlyTick(s);

    if (s.gameOver){ render(); return; }

    // ä¼šè®®è¦†ç›–
    if (s.conference.year === s.year && !s.conference.done && s.month === s.conference.month){
      s.currentEventId = "__conference__";
    } else {
      const e = pickEventFor(s);
      s.currentEventId = e ? e.id : null;
    }
    render();
  }

  // -------------------------
  // æ„å»ºâ€œæœ¬æœˆå¯é€‰è¡ŒåŠ¨â€
  // -------------------------
  function buildOptions(s){
    const list = [];

    // å…¥å­¦é˜¶æ®µï¼šåªæ˜¾ç¤ºå…¥å­¦é€‰é¡¹
    if (!s.milestones.offer){
      const e = events.find(x => x.id === "phd_offer");
      return e ? e.options(s) : [];
    }

    // ä¼šè®®è¦†ç›–
    if (s.currentEventId === "__conference__"){
      list.push(...conferenceEventOptions(s));
      return list;
    }

    // æœ¬æœˆäº‹ä»¶
    const e = events.find(x => x.id === s.currentEventId);
    if (e){
      list.push(...e.options(s));
    }

    // æ€è·¯/çµæ„Ÿå¹¶åˆ—
    if (canUseIdea(s)){
      list.push({ label: "æ²¿ç€ç ”ç©¶æ€è·¯èµ°", run: () => doIdeaPath(s) });
    }
    if (canUseAdvancedIdea(s)){
      list.push({ label: "æ²¿ç€é«˜çº§çµæ„Ÿèµ°", run: () => doAdvancedIdeaPath(s) });
    }

    // ç”Ÿæ´»é€‰é¡¹å¹¶åˆ—ï¼ˆè§£å‹å›ç²¾åŠ›ï¼‰
    list.push(...lifestyleOptions.map(o => ({ label: o.label, run: () => o.run(s) })));

    return list;
  }

  // -------------------------
  // å­˜æ¡£/è¯»æ¡£/é‡å¼€
  // -------------------------
  const SAVE_KEY = "phd_sim_save_v5";
  function saveGame(){
    const payload = { state, usedOnce: Array.from(usedOnce) };
    localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
    state.log.unshift("å·²å­˜æ¡£ã€‚");
    render();
  }
  function loadGame(){
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw){
      state.log.unshift("æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£ã€‚");
      render();
      return;
    }
    try{
      const payload = JSON.parse(raw);
      state = payload.state;

      // å…¼å®¹å­—æ®µ
      if (typeof state.health !== "number") state.health = 60;
      if (typeof state.exp !== "number") state.exp = 20;
      if (!state.flags) state.flags = { ideaGoodReady:false, submittedFromIdea:false };
      if (!state.conference) state.conference = { year: state.year, month: 1 + Math.floor(Math.random()*12), done:false };

      usedOnce.clear();
      (payload.usedOnce || []).forEach(id => usedOnce.add(id));

      state.log.unshift("å·²è¯»æ¡£ã€‚");
      render();
    } catch {
      state.log.unshift("è¯»æ¡£å¤±è´¥ï¼šå­˜æ¡£æŸåã€‚");
      render();
    }
  }
  function restart(){
    state = initialState();
    usedOnce.clear();
    scheduleConferenceForYear(state);
    state.currentEventId = "phd_offer";
    render();
  }

  // -------------------------
  // æ¸²æŸ“
  // -------------------------
  const $ = (id) => document.getElementById(id);

  const elStatsText = $("statsText");
  const elTimeText  = $("timeText");
  const elPaperCount= $("paperCount");
  const elAdvisorAff= $("advisorAff");
  const elEnergy    = $("energy");
  const elHealth    = $("health");
  const elExp       = $("exp");

  const elEventText = $("eventText");
  const elOptions   = $("options");
  const elTip       = $("tip");

  const elItems = $("items");
  const elStatus = $("status");
  const elLog = $("log");

  $("btnSave").onclick = saveGame;
  $("btnLoad").onclick = loadGame;
  $("btnRestart").onclick = restart;

  function render(){
    elStatsText.textContent =
      `æ¯•ä¸šå¸Œæœ› ${state.hope}/100  Â·  å‹åŠ› ${state.pressure}/100  Â·  ç ”ç©¶ ${state.research}/100  Â·  èµ„é‡‘ ${state.money}/100`;
    elTimeText.textContent = `ç¬¬ ${state.year} å¹´ ${state.month} æœˆ`;
    elPaperCount.textContent = String(state.papers);
    elAdvisorAff.textContent = String(state.advisorAff);
    elEnergy.textContent = String(state.energy);
    elHealth.textContent = String(state.health);
    elExp.textContent = String(state.exp);

    if (state.gameOver){
      elEventText.textContent = `${state.ending}\n\nä½ å¯ä»¥ç‚¹å‡»â€œé‡æ–°å¼€å§‹â€ï¼Œæˆ–è€…è¯»æ¡£ç»§ç»­ã€‚`;
      elOptions.innerHTML = "";
      elTip.textContent = "æ¸¸æˆå·²ç»“æŸã€‚";
    } else {
      if (!state.milestones.offer){
        elEventText.textContent = "æ­å–œæ‚¨æ”¶åˆ°äº†æˆ‘ä»¬çš„åšå£«å½•å–é€šçŸ¥ä¹¦ï¼æ‚¨æ„¿æ„æ¥æˆ‘ä»¬å­¦é™¢è¯»åšä¹ˆï¼Ÿ";
        elTip.textContent = "å…¥å­¦é˜¶æ®µï¼šè¯·é€‰æ‹©æ˜¯å¦å…¥å­¦ã€‚";
      } else if (state.currentEventId === "__conference__"){
        elEventText.textContent = "å­¦æœ¯ä¼šè®®æ´»åŠ¨ï¼šä½ æŠµè¾¾äº†ä¼šåœºã€‚æ¥ä¸‹æ¥ä½ ä¼šæ€ä¹ˆåº¦è¿‡è¿™æ®µæ—¶é—´ï¼Ÿ";
        elTip.textContent = "æç¤ºï¼šå­¦æœ¯ä¼šè®®æ¯å¹´ä¼šéšæœºå‡ºç°ä¸€æ¬¡ã€‚";
      } else {
        const e = events.find(x => x.id === state.currentEventId);
        elEventText.textContent = e ? e.text : "è¿™ä¸ªæœˆå¾ˆå¹³é™ã€‚ä½ æƒ³åšç‚¹ä»€ä¹ˆï¼Ÿ";

        const paperNeed = 1;
        const affNeed = 80;
        const paperTip = state.papers >= paperNeed ? `è®ºæ–‡ï¼šå·²æ»¡è¶³ï¼ˆ${state.papers}/${paperNeed}ï¼‰` : `è®ºæ–‡ï¼šæœªæ»¡è¶³ï¼ˆ${state.papers}/${paperNeed}ï¼‰`;
        const affTip = state.advisorAff >= affNeed ? `å¥½æ„Ÿï¼šå·²è¾¾æ ‡ï¼ˆ${state.advisorAff}/${affNeed}ï¼‰` : `å¥½æ„Ÿï¼šæœªè¾¾æ ‡ï¼ˆ${state.advisorAff}/${affNeed}ï¼‰`;

        const ideaN = countItem(state, "ç ”ç©¶æ€è·¯");
        const advN = countItem(state, "é«˜çº§çµæ„Ÿ");
        elTip.textContent = `ä½ å¯ä»¥é€‰æ‹©æ¨è¿›äº‹ä»¶ã€ä½¿ç”¨æ€è·¯/çµæ„Ÿï¼Œæˆ–è¿›è¡Œç”Ÿæ´»è°ƒæ•´ã€‚å½“å‰ï¼šç ”ç©¶æ€è·¯ ${ideaN}ï¼Œé«˜çº§çµæ„Ÿ ${advN}ã€‚æ¯•ä¸šé—¨æ§›ï¼š${paperTip}ï¼Œ${affTip}ã€‚`;
      }

      elOptions.innerHTML = "";
      const opts = buildOptions(state);
      opts.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.textContent = opt.label;
        if (idx === 1) btn.classList.add("secondary");
        btn.onclick = () => opt.run();
        elOptions.appendChild(btn);
      });
    }

    // ç‰©å“
    elItems.innerHTML = "";
    (state.items.length ? state.items : ["ï¼ˆæš‚æ— ï¼‰"]).slice(0,14).forEach(x=>{
      const li = document.createElement("li");
      li.textContent = x;
      elItems.appendChild(li);
    });

    // çŠ¶æ€
    elStatus.innerHTML = "";
    state.status.slice(0,10).forEach(x=>{
      const li = document.createElement("li");
      li.textContent = x;
      elStatus.appendChild(li);
    });

    // æ—¥å¿—
    elLog.innerHTML = "";
    state.log.slice(0,22).forEach(line=>{
      const p = document.createElement("p");
      p.textContent = line;
      elLog.appendChild(p);
    });
  }

  // -------------------------
  // å¯åŠ¨
  // -------------------------
  restart();
})();
</script>
</body>
</html>
